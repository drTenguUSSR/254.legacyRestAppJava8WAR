# Итоги по интеграционному тестированию REST-контроллеров в Spring + Jersey приложении

## Архитектурный контекст
Приложение: Spring 5.2.8 + Jersey 1.19.4 (без Spring Boot)
Сборка: Gradle 6.8.2 + Groovy
Тестирование: JUnit 4.12 + Jersey Test Framework
Контейнер: Grizzly Web Container 1.9.45

## Ключевые проблемы и решения

### 1. Интеграция Spring Context в тестовой среде
Проблема: No WebApplicationContext found: no ContextLoaderListener registered
Решение:
Аннотация @WebAppConfiguration для активации веб-среды
Явная регистрация ContextLoaderListener в WebAppDescriptor
Использование тестового конфига test-applicationContext.xml

### 2. Передача контекста между потоками
Проблема: No thread-bound request found из-за разных потоков теста и сервера
Решение:
Механизм StaticHolder с ConcurrentHashMap для хранения контекстов
Передача testId через HTTP-заголовок X-Cust-Teng-Test-ID
Сервлетный фильтр OverrideRequestAttributesFilter для установки/очистки контекста

### 3. Сериализация/Десериализация JSON
Проблема: No default constructor found для java.sql.Timestamp и java.time.LocalDate
Решение:
Переход на java.time.LocalDate
JAXB-адаптеры для совместимости с Lombok
Использование @XmlJavaTypeAdapter для кастомной сериализации

### 4. Конфигурация фильтров
Проблема: Конфликт между JAX-RS и Servlet фильтрами
Решение:
Явная регистрация через WebAppDescriptor.addFilter()
Правильный порядок выполнения фильтров
Использование GrizzlyWebTestContainerFactory

## Критические компоненты

### OverrideRequestAttributesFilter - центральный элемент
Размещен в src/test/java/mil/teng254/legacy/filter/test/OverrideRequestAttributesFilter.java
Устанавливает Spring RequestContext из testId
Гарантирует очистку в блоке finally
Работает в одном потоке с контроллерами
Применяется только в тестовой среде

### StaticHolder - менеджер контекстов
Thread-safe хранилище RequestAttributes
Ключ - UUID, передаваемый через HTTP-заголовок
Автоматическая очистка в @After методе

### Диагностическая инфраструктура
DiagnosticFilter - мониторинг состояния контекста
Подробное логирование хешей объектов и ID потоков
Валидация передачи данных между компонентами

## Архитектурные принципы
1. Изоляция тестовой конфигурации - отдельный test-applicationContext.xml
2. Явная регистрация компонентов - избегание автоматического сканирования в тестах
3. Thread-local управление состоянием - контроль за распространением контекста
4. Диагностика через идентификаторы - хеши объектов и ID потоков для трассировки
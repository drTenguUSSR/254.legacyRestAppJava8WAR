# dev2025-10-11

## Исходная постановка вопроса

Есть веб приложение:

- Java: Oracle Java 1.8 x64
- Фреймворки: Spring 5.2.8.RELEASE, Jersey 1.19.4 (JAX-RS реализация)
- Сборка: Gradle 6.8.2 + Groovy
- Тестирование: JUnit 4.12, Jersey Test Framework с Grizzly контейнером
- Основные зависимости:
  - Lombok 1.18.20
  - Google Guava 20.0
  - org.apache.logging.log4j:log4j-api:2.4 + SLF4J
  - Jersey 1.19.4 (jersey-bundle, jersey-json, jersey-spring)
  - JAXB API 2.3.1
  - com.sun.jersey.jersey-test-framework:jersey-test-framework-grizzly:1.19.4
- тестовый класс PublicControllerIntegrationTest.java на базе JerseyTest

```java
//вставить
//src/test/java/mil/teng254/legacy/controller/PublicControllerIntegrationTest.java 
```

Задача: изменить процедуру запуска Grizzly, чтобы приложение существовало в
одном экземпляре и прослушивались два tcp-порта (на обоих используется HTTP
протокол). Номера портов задаются в переменных среды - MAIN_PORT и
SPECIAL_PORT.
Если переменные среды не заданы - тесты должны падать.
Также эти номера портов (заданные переменными среды) должны использоваться в тестах.
Ответ привести на русском языке, если не указано иное.
Если нужны уточнения или примеры кода из существующего проекта - задавать вопросы.

## Решение-1. Многопортовый Grizzly1

Основная идея: GrizzlyWebTestContainerFactory - скопировать и кастомизировать,
чтобы GrizzlyWebTestContainer создавал два слушателя

ошибка: приводится код GrizzlyWebTestContainerFactory не соответствующий Jersey 1.19.4
пример: HttpServer.createSimpleServer.

## Решение-2. Многопортовый Tomcat Embedded

### Конфигурация задается в server.xml и ROOT.xml

### Тестовый запуск

```
project-root/
├── src/
│   └── test/
│       └── resources/
│           └── tomcat-config/
│               ├── server.xml                    # основной конфиг сервера
│               └── conf/
│                   └── Catalina/
│                       └── localhost/
│                           └── ROOT.xml          # конфиг контекста приложения
├── build/
│   └── libs/
│       └── ROOT.war                             # собранный WAR-файл
└── target/ (если используется Maven)
```

### Боевой запуск

```
${CATALINA_BASE}/
├── conf/
│   ├── server.xml                              # основной конфиг сервера
│   └── Catalina/
│       └── localhost/
│           └── ROOT.xml                        # конфиг контекста приложения
├── webapps/
│   └── ROOT.war                               # развернутое приложение
├── logs/
└── work/
```

### содержимое ROOT.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Context docBase="ROOT.war"
reloadable="false"
unpackWAR="true">

    <!-- Дополнительные параметры при необходимости -->
    <!-- <Parameter name="someSetting" value="someValue" override="false"/> -->
</Context>
```